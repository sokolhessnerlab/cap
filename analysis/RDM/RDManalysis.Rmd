---
title: 'CAP: RDM analysis'
author: "Hayley Brooks"
date: "5/13/2021"
output: html_document
---

```{r setup, include=FALSE}

library('config')
config = config::get()

rdm_csv = file.path(config$path$combined, config$RDMcsvs$RDM_qualtrics);
exclsnPhs1_csv = file.path(config$path$combined, config$EXCLUSIONcsvs$RDM_AX_Qual_Phs1exclusion);
exclsnPhs2_csv = file.path(config$path$combined, config$EXCLUSIONcsvs$RDM_AX_Qual_Phs2exclusion);

rdmQualtrics = read.csv(rdm_csv); # loads RDM + Qualtrics data both phases (takes several seconds)
excludePhs1 = read.csv(exclsnPhs1_csv); # loads exclusion for phase 1
excludePhs2 = read.csv(exclsnPhs2_csv); # loads exclusion for phase 2

# Remove the extra "X" column present as the first column in datasets
rdmQualtrics = rdmQualtrics[,(2:ncol(rdmQualtrics))];
excludePhs1 = excludePhs1[,(2:ncol(excludePhs1))];
excludePhs2 = excludePhs2[,(2:ncol(excludePhs2))];

# we are going to exclude some people so lets save the original number of subjects
subNumB4exclusion = unique(rdmQualtrics$subID);
nSubB4exclusion = length(subNumB4exclusion);

```


```{r}

library("lme4");
library("ggplot2");
library("ggExtra");

```

#### Applying exlcusion to RDM dataset
```{r}

# Phase 1: 
# RDM: 26 participants excluded
subIDrdmPhs1Exclude = excludePhs1$subID[!is.na(excludePhs1$rdmPhs1exclude) & excludePhs1$rdmPhs1exclude==1]

# Qualtrics: 3 participants excluded
subIDqualPhs1Exclude = excludePhs1$subID[!is.na(excludePhs1$qualPhs1exclude) & excludePhs1$qualPhs1exclude==1]

# Phase 2: 
# RDM: 31 participants excluded
subIDrdmPhs2Exclude = excludePhs2$subID[!is.na(excludePhs2$rdmPhs2exclude) & excludePhs2$rdmPhs2exclude==1]
 
# Qualtrics: 0 participants excluded
subIDqualPhs2Exclude = excludePhs2$subID[!is.na(excludePhs2$qualPhs2exclude) & excludePhs2$qualPhs2exclude==1]


# Put NAs in place of excluded data:
# For now, ust exclude based on RDM or Qualtrics, don't apply an RDM or Qualtrics exclusion across both. 
# This way, we can include as many people as possible within the separate RDM and Qualtrics analyses and when we want to look at RDM + Qualtrics, the NAs will be there for those we need to exclude.

# 
# column order is funky. RDM stuff is in columns 1-5, 7-14, 17-18, and day, phase, and subID are dispersed throughout.
rdmColumns = c(1:5,7:14,17:18);
#rdmColNames = c("rdmRiskyGain", "rdmRiskyLoss","rdmAlternative", "rdmIsi", "rdmIti","rdmItiExtra","rdmRT" ,"rdmOutcome","rdmChoice","rdmGroundEV","rdmEvInd","rdmRunSize" ,"rdmOutcomeType", "rdmTask","rdmTrial");


# Qualtrics stuff starts at column 19, or "stai_s_score" until column 70 or "ses_needbasedCollegeAid_recode"
qualColumns = c(19:70);

#qualColNames = c("stai_s_score", "stai_t_score","pss_score", "pss_stressedToday","uclal_score", "covq_PAB_q1_personalRisk", "covq_PAB_q2_threat", "covq_PAB_q3_personallyDie","covq_PAB_q4_otherPersonDie", "covq_attentionCheck_select_6","covq_attentionCheck_passed", "covq_PAB_q5_currentCases", "covq_PAB_q5_currentCases_recode", "covq_PAB_q6_tested","covq_PAB_q6_tested_recode", "covq_PAB_q7_personalCovidSuspect", "covq_PAB_q7_personalCovidSuspect_recode", "covq_PAB_q8_knowPositivePerson","covq_PAB_q8_knowPositivePerson_recode", "covq_PAB_q9_socialDistanceLevel", "covq_PAB_q9_socialDistanceLevel_recode", "demo_gender","demo_gender_recode", "demo_race","demo_race_recode", "demo_ethnicity","demo_ethnicity_recode", "loc_state","loc_county", "loc_fips", "ses_childhood_freeReducedLunch", "ses_childhood_freeReducedLunch_recode","ses_childhood_communityComp", "ses_childhood_communityComp_recode","ses_childhood_nationalComp", "ses_childhood_nationalComp_recode", "ses_motherEdLevel", "ses_motherEdLevel_recode","ses_fatherEdLevel" , "ses_fatherEdLevel_recode", "ses_childhoood_homeOwnership", "ses_childhoood_homeOwnership_recode","ses_current_billHelp", "ses_current_billHelp_recode","ses_current_mainResponsibilities", "ses_current_mainResponsibilities_recode", "ses_personalEdLevel", "ses_personalEdLevel_recode" ,"ses_financialWorryFreq","ses_financialWorryFreq_recode", "ses_needbasedCollegeAid", "ses_needbasedCollegeAid_recode")
  

# Put NAs in RDM columns for excluded phase 1 and phase 2 participants
rdmQualtrics[rdmQualtrics$subID %in% subIDrdmPhs1Exclude & rdmQualtrics$phase==1,rdmColumns] = NA; # phase 1
rdmQualtrics[rdmQualtrics$subID %in% subIDrdmPhs2Exclude & rdmQualtrics$phase==2,rdmColumns] = NA; # phase 2


# Put NAs in Qualtrics columns for excluded phase 1 and phase 2 participants
rdmQualtrics[rdmQualtrics$subID %in% subIDqualPhs1Exclude & rdmQualtrics$phase==1,qualColumns] = NA; # phase 1
rdmQualtrics[rdmQualtrics$subID %in% subIDqualPhs2Exclude & rdmQualtrics$phase==2,qualColumns] = NA; # phase 2

# Note: if participants were excluded in phase 1, they are not automatically excluded in phase 2!
  
```

#### Remove missed trials - LEFT OFF HERE
```{r}

```



#### Creating variables for analysis - if this gets really large, consider making separate script
```{r}
# add a new variable for phase where phase 1 is now 0 and phase 2 is now 1
rdmQualtrics$phaseRecode = rdmQualtrics$phase;
rdmQualtrics$phaseRecode[rdmQualtrics$phaseRecode==1] = 0;
rdmQualtrics$phaseRecode[rdmQualtrics$phaseRecode==2] = 1;

```

CONSIDER MAKING EVERYTHING ABOVE A SEPARATE "PREPARATION" SCRIPT THAT JUST NEEDS TO BE RUN BEFORE THE ANALYSIS.

#### Participant stuff
```{r}
# Participant IDs included in phase 1 RDM
Phs1subIDs = excludePhs1$subID[excludePhs1$rdmPhs1exclud==0];
Phs1nSub = length(Phs1subIDs); 

# Participant IDs included in phase 2 RDM
Phs2subIDs = excludePhs2$subID[!is.na(excludePhs2$rdmPhs2exclude) & excludePhs2$rdmPhs2exclude==0];
Phs2nSub = length(Phs2subIDs);

# Participant IDs included in both phases 
BothPhsSubIDs = Phs2subIDs[Phs2subIDs %in% Phs1subIDs];
BothPhsnSub = length(BothPhsSubIDs)

sprintf("Prior to exclusion, there were %d participants", nSubB4exclusion)
sprintf("Accounting for exclusion: Phase 1 N = %d and Phase 2 RDM N = %d", Phs1nSub, Phs2nSub);
sprintf("Phase 1 and phase 2 N = %d", BothPhsnSub)
```


### Risky decision-making analysis
#### Probability of gambling
```{r}
# GROUP LEVEL
Phs1Pgam = mean(rdmQualtrics$rdmChoice[rdmQualtrics$phase==1], na.rm=T); # phase 1 pgamble = 0.3901198
Phse2Pgam = mean(rdmQualtrics$rdmChoice[rdmQualtrics$phase==2], na.rm=T); # phase 2 pgamble = 0.3783025
bothPhsPgam = mean(rdmQualtrics$rdmChoice[rdmQualtrics$subID %in% BothPhsSubIDs], na.rm=T); # pgamble across participants who completed both phase 1 and phase (n=313) = 0.3867135

# 95% CI
# phase 1 (n=518)
me1 = qnorm(.975)*(Phs1Pgam/sqrt(Phs1nSub)); #0.03359551
Phs1Pgam + me1; #0.4237153
Phs1Pgam - me1; #0.3565243

# phase 2 (n=326)
me2 = qnorm(.975)*(Phse2Pgam/sqrt(Phs2nSub)); #0.04106563
Phse2Pgam + me2; #0.4193681
Phse2Pgam - me2; #0.3372368

# phase 1 and phase 2 (n = 313)
me3 = qnorm(.975)*(bothPhsPgam/sqrt(BothPhsnSub)); #0.04284156
bothPhsPgam + me3; #0.4295551
bothPhsPgam - me3; #0.343872



# INDIVIDUAL LEVEL

# data frame where each row is a participant and there are 6 columns: {subID, day, phase 1, phase 2, both  phases, diffPgam}. If a participant is not included because they did not complete phase 2 or they were excluded, there will be an NaN in the corresponding  column. "diffPgam" is the difference in probability of gambling between two phases if we have that information for a given participant

pGambleSubID = as.data.frame(matrix(data=NA, nrow =nSubB4exclusion, ncol=6, dimnames=list(c(NULL), c("subID", "day", "phs1pgam","phs2pgam","bothPhspgam", "diffPgam"))))

for (s in 1:nSubB4exclusion) {
  
  
  subPhs1 = rdmQualtrics[rdmQualtrics$subID==subNumB4exclusion[s] & rdmQualtrics$phase==1,rdmColumns];
  subPhs2 = rdmQualtrics[rdmQualtrics$subID==subNumB4exclusion[s] & rdmQualtrics$phase==2,rdmColumns];
  subDay = rdmQualtrics$day[rdmQualtrics$subID==subNumB4exclusion[s]]
  
  pGambleSubID$subID[s] = subNumB4exclusion[s]
  pGambleSubID$day[s] = subDay[1]
  pGambleSubID$phs1pgam[s] = mean(subPhs1$rdmChoice, na.rm=T)
  pGambleSubID$phs2pgam[s] = mean(subPhs2$rdmChoice, na.rm=T)
  pGambleSubID$bothPhspgam[s] = mean(c(subPhs1$rdmChoice, subPhs2$rdmChoice), na.rm=T)
  pGambleSubID$diffPgam[s] = pGambleSubID$phs2pgam[s] - pGambleSubID$phs1pgam[s]
 
};

```

