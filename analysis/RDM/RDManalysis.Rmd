---
title: 'CAP: RDM analysis'
author: "Hayley Brooks"
date: "5/13/2021"
output: html_document
---

Data set up is taken care of by RDMsetup.R script. 
```{r setup, include=FALSE}
rm(list=ls())

library('config')
config = config::get()


setup_source = file.path(config$code_files$rdm_setup_data)
source(setup_source) #, local = knitr::knit_global())


# Looks for existing model file and if its found, then load it and we will now have our previous models in the environment
outputfile = file.path(config$path$Rdata, config$Rdata_files$models)

if(file.exists(outputfile)){
  load(outputfile)
}

```

Plot an example choice set for the gain-only task
```{r}
plot(rdmGainQualtrics$rdmAlternative[rdmGainQualtrics$subID==1], col=rdmGainQualtrics$rdmGroundEV, pch=16, xlab="trial", ylab="safe ($)", main="Safe amounts across the task\ncolors = levels")

plot(rdmGainQualtrics$rdmRiskyGain[rdmGainQualtrics$subID==1], col=rdmGainQualtrics$rdmGroundEV, pch=16, xlab="trial", ylab="risky gain ($)", main="Risky gain amounts across the task\ncolors = levels")

plot(rdmGainQualtrics$rdmGroundEV[rdmGainQualtrics$subID==1], col=rdmGainQualtrics$rdmGroundEV, pch=16, xlab="trial", ylab="level or context ($)", main="Context created by shared expected values")


```
 


### Risky decision-making analysis
#### Probability of gambling GAIN ONLY TASK
```{r}
# GROUP LEVEL

Phs1Pgam = mean(rdmGainQualtrics$rdmChoice[rdmGainQualtrics$phase==1], na.rm=T); # phase 1 pgamble = 0.3813811 (n=516)
Phs2Pgam = mean(rdmGainQualtrics$rdmChoice[rdmGainQualtrics$phase==2], na.rm=T); # phase 2 pgamble = 0.3725557 (n=325)
bothPhsPgam = mean(rdmGainQualtrics$rdmChoice[rdmGainQualtrics$subID %in% BothPhsSubIDs], na.rm=T); # pgamble across participants who completed both phase 1 and phase 2 (n=312) = 0.3795581

# 95% CI
# phase 1 (n=516)
me1 = qnorm(.975)*(Phs1Pgam/sqrt(Phs1nSub)); #0.03290655
Phs1Pgam + me1; #0.4142876
Phs1Pgam - me1; #0.3484745

# phase 2 (n=325)
me2 = qnorm(.975)*(Phs2Pgam/sqrt(Phs2nSub)); #0.04050397
Phs2Pgam + me2; #0.4130596
Phs2Pgam - me2; #0.3320517

# phase 1 and phase 2 (n = 312)
me3 = qnorm(.975)*(bothPhsPgam/sqrt(BothPhsnSub)); #0.04211619
bothPhsPgam + me3; #0.4216743
bothPhsPgam - me3; #0.3374419


# INDIVIDUAL LEVEL

# data frame where each row is a participant and there are 6 columns: {subID, day, phase 1 pgam, phase 2 pgam, both phases pgam, diffPgam}. If a participant is not included because they did not complete phase 2 or they were excluded, there will be an NaN in the corresponding  column. "diffPgam" is the difference in probability of gambling between two phases if we have that information for a given participant

pGambleSubID = as.data.frame(matrix(data=NA, nrow =nSubB4exclusion, ncol=6, dimnames=list(c(NULL), c("subID", "day", "phs1pgam","phs2pgam","bothPhspgam", "diffPgam"))))

for (s in 1:nSubB4exclusion) {
  
  
  subPhs1 = rdmGainQualtrics[rdmGainQualtrics$subID==subNumB4exclusion[s] & rdmGainQualtrics$phase==1,rdmColumns];
  subPhs2 = rdmGainQualtrics[rdmGainQualtrics$subID==subNumB4exclusion[s] & rdmGainQualtrics$phase==2,rdmColumns];
  subDay = rdmGainQualtrics$day[rdmGainQualtrics$subID==subNumB4exclusion[s]]
  
  pGambleSubID$subID[s] = subNumB4exclusion[s]
  pGambleSubID$day[s] = subDay[1]
  pGambleSubID$phs1pgam[s] = mean(subPhs1$rdmChoice, na.rm=T)
  
  if(s %in% Phs1subIDs & s %in% Phs2subIDs){ # for those participants who completed phase 1 and phase 2
    pGambleSubID$phs2pgam[s] = mean(subPhs2$rdmChoice, na.rm=T)
    pGambleSubID$bothPhspgam[s] = mean(c(subPhs1$rdmChoice, subPhs2$rdmChoice), na.rm=T)
    pGambleSubID$diffPgam[s] = pGambleSubID$phs2pgam[s] - pGambleSubID$phs1pgam[s]
  }


};


# plot histogram of the change in risk-taking
# difference is phase 2 - phase 1, so diff > 0 = more risk taking phase 2; diff < 0 = more risk taking phase 1; diff = 0, similar risk taking across phases
summary(pGambleSubID$diffPgam); # mean =-0.01178 (indicating generally more risk taking in phase 1)
hist(pGambleSubID$diffPgam, main="Distribution of change in risk taking", xlab="change in risk-taking\n p(gamble phase 2) - p(gamble phase 1)", ylab="number of participants",breaks = 100);

par(pty = 's'); # make the figure a square
plot(pGambleSubID$phs1pgam, pGambleSubID$phs2pgam, abline(a=0, b=1), xlab="p(gamble phase 1)", ylab="p(gamble phase 2)", main="Risk-taking in both phases (mean in red)", asp=1, ylim=c(0,1), xlim=c(0,1), pch=16, col=rgb(red=0, green=0, blue=0, alpha = 0.3), cex = 3);
points(mean(pGambleSubID$phs1pgam,na.rm=T), mean(pGambleSubID$phs2pgam,na.rm=T), col="red", pch=18, cex=3);


```

#### Simple regressions for risky decision-making GAIN ONLY TASK
1) running on lab computer speeds it up a bit, still take a couple minutes.
2) Use glm to explore but very carefully (these take a second)
3) save the R data models (all model names start with "model" except those we don't want saved will start with "tmp")
 - each model has an if statement (using exist function) so that models we already have don't need to be run again

Note: adding "na.action = na.exclude" retains original row number which we need when pulling out residuals


### DOES TASK-RELATED STUFF ACCOUNT FOR RISK-TAKING (main model plus other variations we tried):
```{r}
# Simple, main model that we will take residuals from to do the remaining analyses (has task events only):
if(!exists('model_task')){
  model_task = glmer(rdmChoice~ 1 + rdmGainSC + rdmSafeSC + rdmGroundEV + (0 + rdmGainSC + rdmSafeSC|subID),data=rdmGainQualtrics,family="binomial",na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)) );
}
# AIC = 73436.9 - this is not the best AIC but we decided that it probably makes the most sense to keep this model simple (just letting task-related stuff do their things) and then see what else accounts for RDM behavior.

# Note: if we put a 1 in the random effects, it could wipe out subject level effects that we are interested in like affective measures (it wouldn't get rid of trial by trial stuff tho)


# Other models that we tried for our first-level and aren't going to use for residual analysis but want to save:

# Task events with phase and day:
if(!exists('model_taskPhaseDay')){
  model_taskPhaseDay=glmer(rdmChoice~ 1 + rdmGainSC + rdmSafeSC + rdmGroundEV + phaseRecode + dayOverallSC + (0 + rdmGainSC + rdmSafeSC|subID),data=rdmGainQualtrics,family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)) );
}
# AIC = 73419.3
# less risk taking in phase 2
# no effect of day 


# Task events with just phase
if(!exists('model_taskPhase')){
  model_taskPhase=glmer(rdmChoice~ 1 + rdmGainSC + rdmSafeSC + rdmGroundEV + phaseRecode + (0 + rdmGainSC + rdmSafeSC|subID),data=rdmGainQualtrics,family="binomial",na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)) );
}
# AIC = 73419.2
# less risk taking in phase 2

```

### Store residuals from our main model (model_task):
```{r}
rdmGainQualtrics$predmTask = predict(model_task, type="link"); 
```

### Models that involve residuals (the bulk of the analysis):

```{r}
# STAIS, STAIT, UCLAL, PSS:
if(!exists('model_pred_stais')){
  model_pred_stais = glmer(rdmChoice~  0 + stai_s_score_scaled + (1|subID), data=rdmGainQualtrics, family="binomial", control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
# singular
# no effect of stais
# AIC = 68601.5
# nObs = 98833

if(!exists('model_pred_stait')){
  model_pred_stait = glmer(rdmChoice~  0 + stai_t_score_scaled + (1|subID), data=rdmGainQualtrics, family="binomial", control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask  );
}
# no effect of stait
# AIC = 68601.5
# nObs = 98833
# singular

if(!exists('model_pred_uclal')){
  model_pred_uclal = glmer(rdmChoice~  0 + uclal_score_scaled + (1|subID), data=rdmGainQualtrics, family="binomial", control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)) ,offset=predmTask  );
}
# no effect of uclal
# AIC = 68601.5
# nObs = 98833
# singular


if(!exists('model_pred_pss')){
  model_pred_pss = glmer(rdmChoice~ 0 + pss_score_scaled + (1|subID), data=rdmGainQualtrics, family="binomial", control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)),offset=predmTask )
}
# no effect of pss
# AIC = 68601.6
# nObs = 98833
# singular


# COVID RISK: 

# covid risk mean: 5.26 phase 1 and 5.04 in phase 2 - TODO: follow up on this when we make individual-level affect dataframe


# GLMER models turning out singular warning because random effects have very small variance - use GLM instead (beta and pvalue are exactly the same in glmer and glm)



# covid risk variable is capturing across and within subject stuff:
# 1) resrict data to one phase and if the pattern holds up, we atleast know that individual differences do matter
  
# Adding covid risk to trial-level model (*prior to residuals*) to address concern that putting covid risk in second-step model may be making it difficult to see effects: rdmChoice ~ 1 + rdmGainSC + rdmSafeSC + rdmGroundEV + covq_PAB_q1_personalRisk_scaledNoNA
# just phase 1 data - negative and significant; just phase 2 - negative and significant 
  
# When doing: glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA  + (1|subID) with offset and restricting data to just one phase
# Phase 1: beta = -0.009468, p = .81 and Phase 2: beta = -0.23339, p = 0.0012
  # so this means that its always the case that lower covid risk is associated with more risk-taking but more so in phase 2.
  # if lower covid risk means more risk-taking then risk-taking should increase in phase 2 but it decreases

if(!exists('model_pred_covidRisk')){
  model_pred_covidRisk= glm(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA, data=rdmGainQualtrics, family="binomial", na.action=na.exclude, offset=predmTask ); 
}
#                                     Estimate Std. Error z value Pr(>|z|)  
# covq_PAB_q1_personalRisk_scaledNoNA -0.03103    0.01589  -1.953   0.0509 .

# AIC 68716
# COVID perceived risk doesn't significantly affect risk-taking, overall. 

# Might this differ across separate phases?
if(!exists('model_pred_covidRisk_phase1')){
  model_pred_covidRisk_phase1 = glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA  + (1|subID), data=rdmGainQualtrics[rdmGainQualtrics$phase==1,], family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
# No significant effect of perceived risk in phase 1 (B = -0.01345, p = 0.741)

if(!exists('model_pred_covidRisk_phase2')){
  model_pred_covidRisk_phase2 = glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA  + (1|subID), data=rdmGainQualtrics[rdmGainQualtrics$phase==2,], family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
# Significant effect of perceived risk in phase 2 (B = -0.25427, p = 0.000968 ***)

# --> Perceived COVID risk appears to negatively affect risk-taking in phase 2, but not phase 1.

# This shows up when interacting phase with perceived COVID risk
if(!exists('model_pred_covidRisk_x_phase')){
  model_pred_covidRisk_x_phase = glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA*phaseRecode + (1|subID), data=rdmGainQualtrics, family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
#                                                 Estimate Std. Error z value Pr(>|z|)    
# covq_PAB_q1_personalRisk_scaledNoNA              0.02604    0.02000   1.302  0.19280    
# phaseRecode                                      0.10718    0.03481   3.079  0.00208 ** 
# covq_PAB_q1_personalRisk_scaledNoNA:phaseRecode -0.32243    0.06385  -5.050 4.42e-07 ***
#
# AIC: 68690.6

# Two opposing effects... risk-taking significantly INCREASES in phase 2 when perceived COVID risk is 0/low, but DECREASES in phase 2 the higher participants perceive the risk of COVID. 

# A very similar approach using DAY instead of PHASE outperforms on the basis of AIC:
if(!exists('model_pred_covidRisk_x_dayOverallSC')){
  model_pred_covidRisk_x_dayOverallSC = glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC + (1|subID), data=rdmGainQualtrics, family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
# NOTE: none of these models *should* be glmers; RFX terms have 0 variance
#                                                  Estimate Std. Error z value Pr(>|z|)    
# covq_PAB_q1_personalRisk_scaledNoNA               0.08415    0.03001   2.805  0.00504 ** 
# dayOverallSC                                      0.19198    0.04150   4.626 3.73e-06 ***
# covq_PAB_q1_personalRisk_scaledNoNA:dayOverallSC -0.56599    0.09012  -6.281 3.37e-10 ***
#
# AIC: 68682.4 <-- MUCH better than phase 

# This implies a small positive relationship between perceived COVID risk and risk-taking on Day 0, followed by two contrasting effects; a positive effect of Day (INCREASED risk-taking for those with 0/low perceived COVID risk with increasing day), and a strong negative interaction between Day and perceived COVID risk (DECREASED risk-taking for those who perceive significant COVID risk as day increases)

# (if you run this model with phaseRecode and daySC (which is 1:20, 1:20), you recover the above pattern, no 3-way interaction btwn day, phase, & COVID risk)

# Predicted p(gamble) by perceived COVID risk and Day are...
# no perceived risk: 0.5 on Day 0, 0.56 on Day 40 [RISES]
# moderate perceived risk: 0.51 on Day 0, 0.49 on Day 40 [STAYS FLAT]
# high perceived risk: 0.52 on Day 0, 0.43 on Day 40 [DROPS]

# This pattern predicts more variability across participants in risk-taking in phase 2 than phase 1. Estimates of variance across phase corroborate this:
var_phase1 = var(pGambleSubID$phs1pgam[is.finite(pGambleSubID$phs2pgam)],na.rm=T)
# 0.0389
var_phase2 = var(pGambleSubID$phs2pgam,na.rm=T)
# 0.0461

var.test(pGambleSubID$phs1pgam[is.finite(pGambleSubID$phs2pgam)],pGambleSubID$phs2pgam)
# These variances aren't significantly different; p = 0.14

covriskphs1 = rdmGainQualtrics$covq_PAB_q1_personalRisk_scaled[which((rdmGainQualtrics$rdmTrial==1)&(rdmGainQualtrics$phase==1))]; # perceived covid risk, phase 1
covriskphs2 = rdmGainQualtrics$covq_PAB_q1_personalRisk_scaled[which((rdmGainQualtrics$rdmTrial==1)&(rdmGainQualtrics$phase==2))]; # perceived COVID risk, phase 2

var(covriskphs1,na.rm=T); # 0.06312781
var(covriskphs2,na.rm=T); # 0.06240118

mean(covriskphs1,na.rm=T); # 0.5322816
mean(covriskphs2,na.rm=T); # 0.5015385 
# Decrease in perceived risk is trending p = 0.08

rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA = (rdmGainQualtrics$covq_PAB_q1_personalRisk-5)/4;
rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA[is.na(rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA)] = 0;

if(!exists('model_pred_covidRiskCentered_x_dayOverallSC')){
  model_pred_covidRiskCentered_x_dayOverallSC = glmer(rdmChoice ~  1 + covq_PAB_q1_personalRisk_centeredscaledNoNA*dayOverallSC + (1|subID), data=rdmGainQualtrics, family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}

#                                                          Estimate Std. Error z value Pr(>|z|)   
# (Intercept)                                               0.05343    0.01807   2.956  0.00312 **
# covq_PAB_q1_personalRisk_centeredscaledNoNA               0.01071    0.03546   0.302  0.76265   
# dayOverallSC                                             -0.10857    0.03402  -3.192  0.00141 **
# covq_PAB_q1_personalRisk_centeredscaledNoNA:dayOverallSC -0.22195    0.06870  -3.231  0.00124 **
#
# AIC: 68686.4 <-- worse


# 2) relate changes in risk taking to changes in perceived risk (using a variable that captures the difference in covid risk across phase 1)

# Affective measures... 
# - No observed effects (at this level) for STAIS, STAIT, UCLA-L or PSS
# - covid risk measure predicts less risk -taking
# model w/ covid risk (AIC = 73465.6) outperforms model with phase and day(AIC = 73516.2) and just phase (AIC =73516.4)

```


```{r}

# TEMPORAL CONTEXT WITH COVID RISK:
if(!exists('model_pred_3timescales_covidRisk')){
  model_pred_3timescales_covidRisk = glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC + (1|subID), data=rdmGainQualtrics, na.action = na.exclude, family="binomial", offset=predmTask);
}

# AIC = 67018.3 (outperforms models w/o temporal context factors)
# nObs = 97093
#
# Expected effects with earnings (+), trial (-), posShift (+), COV RISK (+), Day (+), COV Risk x Day (-)
# No effect of previous outcome



# TEMPORAL CONTEXT WITHOUT COVID RISK:
if(!exists('model_pred_3timescales')){
  model_pred_3timescales= glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + (1|subID), data=rdmGainQualtrics, family="binomial", offset=predmTask);
}

# AIC =  67083.9
# everything significant, positive effect of past outcome, earnings (positive) and trial (negative) have opposing effects, shift positive, interaction between past outcome and earnings negative
# singular
# nObs = 97093



if(!exists('model_pred_3timescales_sesPCA')){
  model_pred_3timescales_sesPCA = glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + sesPCA + (1|subID), data=rdmGainQualtrics, na.action = na.exclude, family="binomial", offset=predmTask);
}

# AIC = 56355.9
# No significant effect of SES
# 
# nObs = 81939 (MUCH LESS DATA FOR THIS; NOT EVERYONE ANSWERED SES QUESTIONS; missing 16% of data)


if(!exists('model_pred_3timescales_covidRisk_sesPCA')){
  model_pred_3timescales_covidRisk_sesPCA = glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC*sesPCA + (1|subID), data=rdmGainQualtrics, na.action = na.exclude, family="binomial", offset=predmTask);
}

# AIC = 56291.5
# Main contextual effects & perceived COVID risk effects remain. No SES effects or interactions.
# nObs: 81939


# HOW TO PROCEED?
# 
# Many unanswered questions re: SES and our main contextual effects
# Previous outcome effect is weak/moves around... is there a missing covariate here? 
# 
# Ways forward?
# Option 1: Interact CovRisk*DayOverall terms with e.g. POC, earnings, shift, etc. (probably just do this w/ glm, not glmer)
# Option 2: Run separate, independent regressions, e.g. on those w/ low perceived risk, moderate perceived risk, and high perceived risk. 

# Next steps:
# 1. Divide decision-making into thirds on the basis of perceived COVID risk for separate regressions.
# 2. Run regressions with POC, cumearnings, trial, shift, and dayoverallSC separately
# 3. Run large, interactive regression (GLM).


# 1. Divide decision-making into thirds on the basis of perceived COVID risk for separate regressions.
  # no risk = -1, -.75, -.5
  # moderate-to-none risk = -.25, 0, + .25
  # high risk = +.5, +.75, +1

noRiskRDM = rdmGainQualtrics[rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA %in% c(-1, -.75, -.5),]; #24871 rows
modRiskRDM = rdmGainQualtrics[rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA %in% c(-.25, 0, .25),]; #52836 rows
highRiskRDM = rdmGainQualtrics[rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA %in% c(.5, .75, 1),];  #29512 rows

# Splitting up the data another way: By pushing the middle people to the "extremes" we may be covering up some effects but generally the pattern was similar using this dataset.
# noRiskRDM = rdmGainQualtrics[rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA %in% c(-1, -.75, -.5, -.25),]; #34391 rows
# modRiskRDM = rdmGainQualtrics[rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA %in% c(0),]; #30107 rows
# highRiskRDM = rdmGainQualtrics[rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA %in% c(.25,.5, .75, 1),];  #42721 rows


# 2. Run regressions with POC, cumearnings, trial, shift, and dayoverallSC separately
# NO PERCEIVED RISK
if(!exists('model_pred_3timescales_covidRisk_noRiskGroup')){
model_pred_3timescales_covidRisk_noRiskGroup = glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + dayOverallSC + (1|subID), data=noRiskRDM, na.action = na.exclude, family="binomial", offset=predmTask);
};
# AIC = 14139.1; nobs = 22913
# a lot of trending things - earnings (+), shift (+), trial (-) and day (+) all trending between .06 and .08
# no effect of past outcome or interaction between earnings and past outcome

# positive outcome effect becomes negative outcome effect (within session) on day zero
.89120 - 1.37208 = -0.48088 #(poc effect, beginning session) - (pastoutcome *earnings) at the end of day 1
.89120 + -2.27464 = -1.38344 # (poc effect beginning session, last day) - last day effect (start of last day)
.89120 + -2.27464 + - 1.37208 + 2.72881 = -0.02671 # (poc effect beginning session last day)- last day effect (at the start) - pastoutcome*earnings + end of last day earnings

# in general, past outcome effect becomes more negative overtime.
# overall, it seems like context effects change with whatever else is going on.
# ^^ IN PEOPLE WITH NO PERCEIVED RISK

# positive outcome effect starts negative goes positive (within session) on last day

if(!exists('model_pred_3timescales_covidRisk_noRiskGroup_dayintx')){
model_pred_3timescales_covidRisk_noRiskGroup_dayintx= glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC*dayOverallSC + posShift*dayOverallSC +  rdmTrialSC*dayOverallSC + (1|subID), data=noRiskRDM, na.action = na.exclude, family="binomial", offset=predmTask);
};
# AIC =14129.1 ; nobs = 22913
# significant: poc(+), day (+), poc*earnings(-), poc*day(-), poc*earnings*day(+)
# everything else is not significant

# MODERATE RISK:
if(!exists('model_pred_3timescales_covidRisk_modRiskGroup')){
model_pred_3timescales_covidRisk_modRiskGroup= glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + dayOverallSC + (1|subID), data=modRiskRDM, na.action = na.exclude, family="binomial", offset=predmTask);
};
# AIC = 32639.4; nobs = 47009
# earnings (+), shift (+), trial (-) all significant
# day not significant beta = .01, p = .78
# no effect of past outcome or interaction between earnings and past outcome


if(!exists('model_pred_3timescales_covidRisk_modRiskGroup_dayintx')){
model_pred_3timescales_covidRisk_modRiskGroup_dayintx= glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC*dayOverallSC + posShift*dayOverallSC +  rdmTrialSC*dayOverallSC + (1|subID), data=modRiskRDM, na.action = na.exclude, family="binomial", offset=predmTask);
};
# AIC = 32643.2; nobs = 47009
# day(+) is trending (p=.064) as well as the interaction between poc, earnings and day (+, p=.07)
# everything else is not significant

# HIGH RISK:
if(!exists('model_pred_3timescales_covidRisk_highRiskGroup')){
model_pred_3timescales_covidRisk_highRiskGroup= glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + dayOverallSC + (1|subID), data=highRiskRDM, na.action = na.exclude, family="binomial", offset=predmTask);
};

# AIC = 19828.7; nobs = 27171
# things are generally more significant for high perceived risk group
# past outcome (+), earnings (+), shift (+), trial (-), day (-) all significant
# interaction between outcome and earnings is negative and trending p = .09

if(!exists('model_pred_3timescales_covidRisk_highRiskGroup_dayintx')){
model_pred_3timescales_covidRisk_highRiskGroup_dayintx= glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC*dayOverallSC + posShift*dayOverallSC +  rdmTrialSC*dayOverallSC + (1|subID), data=highRiskRDM, na.action = na.exclude, family="binomial", offset=predmTask);
};
#AIC = 19819.2; nobs = 27171
# poc (+), poc*earning (-), poc*day(-), poc*earn*day (+) are all significant
# day*trial (-) is trending
# everything else is not significant

# positive outcome effect becomes negative outcome effect (within session) on day zero
.57652 -1.42379 = -0.84727 #(poc effect, beginning session) - (pastoutcome *earnings) at the end of day 1
.57652 + -1.17169  = -0.59517 # (poc effect beginning session, last day) - last day effect (start of last day)
.57652 + -1.17169  + -1.42379 + 3.20356 =  1.1846 # (poc effect beginning session last day)- last day effect (at the start) - pastoutcome*earnings + end of last day earnings. Last day it goes negative to positive within a session.

# this is a similar pattern/direction effect but its not as strong in the high risk.
# for the high risk people, they look similar to no risk people. however, at the start of the last day, the past outcome effect in high risk people is much less negative than no risk people. And the two groups end in different places too (high risk past outcome effect is 1.18 whereas no risk past outcome effect -.03).





# Summary: temporal context effects stronger as perceived covid risk increases (in the first models for the three groups)
# these models match our previous model findings wrt to day and risk - that people with no perceived risk take more risk across days, people with moderate have no change in risk across days and people with high perceived risk take less risks across days.
# interacting day in these groups has different results - suggesting that not only is risk-taking globally shifting as a function of day but day might also be moderating context effects in the no and high risk groups.
# how to deal with different amounts of data here?
# should we consider some more complex interactions within each of these models, for example, with pcaSES?


# 3. Run large, interactive regression (GLM).

if(!exists('model_pred_3timescales_covidRisk_dayintx_BIGMODEL')){
  model_pred_3timescales_covidRisk_dayintx_BIGMODEL = glm(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC*covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC + posShift*covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC +  rdmTrialSC*covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC, data=rdmGainQualtrics, na.action = na.exclude, family="binomial", offset=predmTask);
}


if(!exists('model_pred_3timescales_covidRisk_dayintx_BIGMODEL_glmer')){
  model_pred_3timescales_covidRisk_dayintx_BIGMODEL_glmer = glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC*covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC + posShift*covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC +  rdmTrialSC*covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC + (1|subID), data=rdmGainQualtrics, na.action = na.exclude, family="binomial", offset=predmTask);
}
# AIC = 66994.3; nobs = 97093 (compared to model above with just covid risk and day but no interactions: AIC = 67018.3)

# sig: poc (+), covid risk(+), day (+), poc*earn(-), poc*risk (-), poc*day(-), risk*day (-), poc*earn*risk(+), poc*earn*day(+), poc*risk*day(+)
# a few trending things and the rest are significant

# at this point, the take away is that perceived risk is important and that temporal context effects change across risk and day. 

# Next steps:
# trying to wrap our heads around the overall pattern from this massive model. Break it down by four situations:
# low-risk day 1
# high-risk day 1
# low-risk day 40
# high-risk day 40
# with respect to temporal context effects (poc, earnings and shift)

```



```{r}
# save our models
save(file=outputfile, list=ls(pattern=glob2rx("model*"))); 
```

