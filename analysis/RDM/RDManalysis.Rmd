---
title: 'CAP: RDM analysis'
author: "Hayley Brooks"
date: "5/13/2021"
output: html_document
---

Data set up is taken care of by RDMsetup.R script. 
```{r setup, include=FALSE}
rm(list=ls())

library('config')
config = config::get()


setup_source = file.path(config$code_files$setup_data)
source(setup_source) #, local = knitr::knit_global())


# Looks for existing model file and if its found, then load it and we will now have our previous models in the environment
outputfile = file.path(config$path$Rdata, config$Rdata_files$models)

if(file.exists(outputfile)){
  load(outputfile)
}

```

Plot an example choice set for the gain-only task
```{r}
plot(rdmGainQualtrics$rdmAlternative[rdmGainQualtrics$subID==1], col=rdmGainQualtrics$rdmGroundEV, pch=16, xlab="trial", ylab="safe ($)", main="Safe amounts across the task\ncolors = levels")

plot(rdmGainQualtrics$rdmRiskyGain[rdmGainQualtrics$subID==1], col=rdmGainQualtrics$rdmGroundEV, pch=16, xlab="trial", ylab="risky gain ($)", main="Risky gain amounts across the task\ncolors = levels")

plot(rdmGainQualtrics$rdmGroundEV[rdmGainQualtrics$subID==1], col=rdmGainQualtrics$rdmGroundEV, pch=16, xlab="trial", ylab="level or context ($)", main="Context created by shared expected values")


```
 


### Risky decision-making analysis
#### Probability of gambling GAIN ONLY TASK
```{r}
# GROUP LEVEL

Phs1Pgam = mean(rdmGainQualtrics$rdmChoice[rdmGainQualtrics$phase==1], na.rm=T); # phase 1 pgamble = 0.3813811 (n=516)
Phs2Pgam = mean(rdmGainQualtrics$rdmChoice[rdmGainQualtrics$phase==2], na.rm=T); # phase 2 pgamble = 0.3725557 (n=325)
bothPhsPgam = mean(rdmGainQualtrics$rdmChoice[rdmGainQualtrics$subID %in% BothPhsSubIDs], na.rm=T); # pgamble across participants who completed both phase 1 and phase 2 (n=312) = 0.3795581

# 95% CI
# phase 1 (n=516)
me1 = qnorm(.975)*(Phs1Pgam/sqrt(Phs1nSub)); #0.03290655
Phs1Pgam + me1; #0.4142876
Phs1Pgam - me1; #0.3484745

# phase 2 (n=325)
me2 = qnorm(.975)*(Phs2Pgam/sqrt(Phs2nSub)); #0.04050397
Phs2Pgam + me2; #0.4130596
Phs2Pgam - me2; #0.3320517

# phase 1 and phase 2 (n = 312)
me3 = qnorm(.975)*(bothPhsPgam/sqrt(BothPhsnSub)); #0.04211619
bothPhsPgam + me3; #0.4216743
bothPhsPgam - me3; #0.3374419


# INDIVIDUAL LEVEL

# data frame where each row is a participant and there are 6 columns: {subID, day, phase 1 pgam, phase 2 pgam, both phases pgam, diffPgam}. If a participant is not included because they did not complete phase 2 or they were excluded, there will be an NaN in the corresponding  column. "diffPgam" is the difference in probability of gambling between two phases if we have that information for a given participant

pGambleSubID = as.data.frame(matrix(data=NA, nrow =nSubB4exclusion, ncol=6, dimnames=list(c(NULL), c("subID", "day", "phs1pgam","phs2pgam","bothPhspgam", "diffPgam"))))

for (s in 1:nSubB4exclusion) {
  
  
  subPhs1 = rdmGainQualtrics[rdmGainQualtrics$subID==subNumB4exclusion[s] & rdmGainQualtrics$phase==1,rdmColumns];
  subPhs2 = rdmGainQualtrics[rdmGainQualtrics$subID==subNumB4exclusion[s] & rdmGainQualtrics$phase==2,rdmColumns];
  subDay = rdmGainQualtrics$day[rdmGainQualtrics$subID==subNumB4exclusion[s]]
  
  pGambleSubID$subID[s] = subNumB4exclusion[s]
  pGambleSubID$day[s] = subDay[1]
  pGambleSubID$phs1pgam[s] = mean(subPhs1$rdmChoice, na.rm=T)
  
  if(s %in% Phs1subIDs & s %in% Phs2subIDs){ # for those participants who completed phase 1 and phase 2
    pGambleSubID$phs2pgam[s] = mean(subPhs2$rdmChoice, na.rm=T)
    pGambleSubID$bothPhspgam[s] = mean(c(subPhs1$rdmChoice, subPhs2$rdmChoice), na.rm=T)
    pGambleSubID$diffPgam[s] = pGambleSubID$phs2pgam[s] - pGambleSubID$phs1pgam[s]
  }


};


# plot histogram of the change in risk-taking
# difference is phase 2 - phase 1, so diff > 0 = more risk taking phase 2; diff < 0 = more risk taking phase 1; diff = 0, similar risk taking across phases
summary(pGambleSubID$diffPgam); # mean =-0.01178 (indicating generally more risk taking in phase 1)
hist(pGambleSubID$diffPgam, main="Distribution of change in risk taking", xlab="change in risk-taking\n p(gamble phase 2) - p(gamble phase 1)", ylab="number of participants",breaks = 100);

par(pty = 's'); # make the figure a square
plot(pGambleSubID$phs1pgam, pGambleSubID$phs2pgam, abline(a=0, b=1), xlab="p(gamble phase 1)", ylab="p(gamble phase 2)", main="Risk-taking in both phases (mean in red)", asp=1, ylim=c(0,1), xlim=c(0,1), pch=16, col=rgb(red=0, green=0, blue=0, alpha = 0.3), cex = 3);
points(mean(pGambleSubID$phs1pgam,na.rm=T), mean(pGambleSubID$phs2pgam,na.rm=T), col="red", pch=18, cex=3);


```

#### Simple regressions for risky decision-making GAIN ONLY TASK
1) running on lab computer speeds it up a bit, still take a couple minutes.
2) Use glm to explore but very carefully (these take a second)
3) save the R data models (all model names start with "model" except those we don't want saved will start with "tmp")
 - each model has an if statement (using exist function) so that models we already have don't need to be run again

Note: adding "na.action = na.exclude" retains original row number which we need when pulling out residuals


### DOES TASK-RELATED STUFF ACCOUNT FOR RISK-TAKING (main model plus other variations we tried):
```{r}
# Simple, main model that we will take residuals from to do the remaining analyses (has task events only):
if(!exists('model_task')){
  model_task = glmer(rdmChoice~ 1 + rdmGainSC + rdmSafeSC + rdmGroundEV + (0 + rdmGainSC + rdmSafeSC|subID),data=rdmGainQualtrics,family="binomial",na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)) );
}
# AIC = 73436.9 - this is not the best AIC but we decided that it probably makes the most sense to keep this model simple (just letting task-related stuff do their things) and then see what else accounts for RDM behavior.

# Note: if we put a 1 in the random effects, it could wipe out subject level effects that we are interested in like affective measures (it wouldn't get rid of trial by trial stuff tho)


# Other models that we tried for our first-level and aren't going to use for residual analysis but want to save:

# Task events with phase and day:
if(!exists('model_taskPhaseDay')){
  model_taskPhaseDay=glmer(rdmChoice~ 1 + rdmGainSC + rdmSafeSC + rdmGroundEV + phaseRecode + dayOverallSC + (0 + rdmGainSC + rdmSafeSC|subID),data=rdmGainQualtrics,family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)) );
}
# AIC = 73419.3
# less risk taking in phase 2
# no effect of day 


# Task events with just phase
if(!exists('model_taskPhase')){
  model_taskPhase=glmer(rdmChoice~ 1 + rdmGainSC + rdmSafeSC + rdmGroundEV + phaseRecode + (0 + rdmGainSC + rdmSafeSC|subID),data=rdmGainQualtrics,family="binomial",na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)) );
}
# AIC = 73419.2
# less risk taking in phase 2

```

### Store residuals from our main model (model_task):
```{r}
rdmGainQualtrics$predmTask = predict(model_task, type="link"); 
```

### Models that involve residuals (the bulk of the analysis):

```{r}
# STAIS, STAIT, UCLAL, PSS:
if(!exists('model_pred_stais')){
  model_pred_stais = glmer(rdmChoice~  0 + stai_s_score_scaled + (1|subID), data=rdmGainQualtrics, family="binomial", control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
# singular
# no effect of stais
# AIC = 68601.5
# nObs = 98833

if(!exists('model_pred_stait')){
  model_pred_stait = glmer(rdmChoice~  0 + stai_t_score_scaled + (1|subID), data=rdmGainQualtrics, family="binomial", control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask  );
}
# no effect of stait
# AIC = 68601.5
# nObs = 98833
# singular

if(!exists('model_pred_uclal')){
  model_pred_uclal = glmer(rdmChoice~  0 + uclal_score_scaled + (1|subID), data=rdmGainQualtrics, family="binomial", control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)) ,offset=predmTask  );
}
# no effect of uclal
# AIC = 68601.5
# nObs = 98833
# singular


if(!exists('model_pred_pss')){
  model_pred_pss = glmer(rdmChoice~ 0 + pss_score_scaled + (1|subID), data=rdmGainQualtrics, family="binomial", control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)),offset=predmTask )
}
# no effect of pss
# AIC = 68601.6
# nObs = 98833
# singular


# COVID RISK: 

# covid risk mean: 5.26 phase 1 and 5.04 in phase 2 - TODO: follow up on this when we make individual-level affect dataframe


# GLMER models turning out singular warning because random effects have very small variance - use GLM instead (beta and pvalue are exactly the same in glmer and glm)



# covid risk variable is capturing across and within subject stuff:
# 1) resrict data to one phase and if the pattern holds up, we atleast know that individual differences do matter
  
# Adding covid risk to trial-level model (*prior to residuals*) to address concern that putting covid risk in second-step model may be making it difficult to see effects: rdmChoice ~ 1 + rdmGainSC + rdmSafeSC + rdmGroundEV + covq_PAB_q1_personalRisk_scaledNoNA
# just phase 1 data - negative and significant; just phase 2 - negative and significant 
  
# When doing: glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA  + (1|subID) with offset and restricting data to just one phase
# Phase 1: beta = -0.009468, p = .81 and Phase 2: beta = -0.23339, p = 0.0012
  # so this means that its always the case that lower covid risk is associated with more risk-taking but more so in phase 2.
  # if lower covid risk means more risk-taking then risk-taking should increase in phase 2 but it decreases

if(!exists('model_pred_covidRisk')){
  model_pred_covidRisk= glm(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA, data=rdmGainQualtrics, family="binomial", na.action=na.exclude, offset=predmTask ); 
}
#                                     Estimate Std. Error z value Pr(>|z|)  
# covq_PAB_q1_personalRisk_scaledNoNA -0.03103    0.01589  -1.953   0.0509 .

# AIC 68716
# COVID perceived risk doesn't significantly affect risk-taking, overall. 

# Might this differ across separate phases?
if(!exists('model_pred_covidRisk_phase1')){
  model_pred_covidRisk_phase1 = glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA  + (1|subID), data=rdmGainQualtrics[rdmGainQualtrics$phase==1,], family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
# No significant effect of perceived risk in phase 1 (B = -0.01345, p = 0.741)

if(!exists('model_pred_covidRisk_phase2')){
  model_pred_covidRisk_phase2 = glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA  + (1|subID), data=rdmGainQualtrics[rdmGainQualtrics$phase==2,], family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
# Significant effect of perceived risk in phase 2 (B = -0.25427, p = 0.000968 ***)

# --> Perceived COVID risk appears to negatively affect risk-taking in phase 2, but not phase 1.

# This shows up when interacting phase with perceived COVID risk
if(!exists('model_pred_covidRisk_x_phase')){
  model_pred_covidRisk_x_phase = glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA*phaseRecode + (1|subID), data=rdmGainQualtrics, family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
#                                                 Estimate Std. Error z value Pr(>|z|)    
# covq_PAB_q1_personalRisk_scaledNoNA              0.02604    0.02000   1.302  0.19280    
# phaseRecode                                      0.10718    0.03481   3.079  0.00208 ** 
# covq_PAB_q1_personalRisk_scaledNoNA:phaseRecode -0.32243    0.06385  -5.050 4.42e-07 ***
#
# AIC: 68690.6

# Two opposing effects... risk-taking significantly INCREASES in phase 2 when perceived COVID risk is 0/low, but DECREASES in phase 2 the higher participants perceive the risk of COVID. 

# A very similar approach using DAY instead of PHASE outperforms on the basis of AIC:
if(!exists('model_pred_covidRisk_x_dayOverallSC')){
  model_pred_covidRisk_x_dayOverallSC = glmer(rdmChoice ~  0 + covq_PAB_q1_personalRisk_scaledNoNA*dayOverallSC + (1|subID), data=rdmGainQualtrics, family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}
# NOTE: none of these models *should* be glmers; RFX terms have 0 variance
#                                                  Estimate Std. Error z value Pr(>|z|)    
# covq_PAB_q1_personalRisk_scaledNoNA               0.08415    0.03001   2.805  0.00504 ** 
# dayOverallSC                                      0.19198    0.04150   4.626 3.73e-06 ***
# covq_PAB_q1_personalRisk_scaledNoNA:dayOverallSC -0.56599    0.09012  -6.281 3.37e-10 ***
#
# AIC: 68682.4 <-- MUCH better than phase 

# This implies a small positive relationship between perceived COVID risk and risk-taking on Day 0, followed by two contrasting effects; a positive effect of Day (INCREASED risk-taking for those with 0/low perceived COVID risk with increasing day), and a strong negative interaction between Day and perceived COVID risk (DECREASED risk-taking for those who perceive significant COVID risk as day increases)

# (if you run this model with phaseRecode and daySC (which is 1:20, 1:20), you recover the above pattern, no 3-way interaction btwn day, phase, & COVID risk)

# Predicted p(gamble) by perceived COVID risk and Day are...
# no perceived risk: 0.5 on Day 0, 0.56 on Day 40 [RISES]
# moderate perceived risk: 0.51 on Day 0, 0.49 on Day 40 [STAYS FLAT]
# high perceived risk: 0.52 on Day 0, 0.43 on Day 40 [DROPS]

# This pattern predicts more variability across participants in risk-taking in phase 2 than phase 1. Estimates of variance across phase corroborate this:
var_phase1 = var(pGambleSubID$phs1pgam[is.finite(pGambleSubID$phs2pgam)],na.rm=T)
# 0.0389
var_phase2 = var(pGambleSubID$phs2pgam,na.rm=T)
# 0.0461

var.test(pGambleSubID$phs1pgam[is.finite(pGambleSubID$phs2pgam)],pGambleSubID$phs2pgam)
# These variances aren't significantly different; p = 0.14

covriskphs1 = rdmGainQualtrics$covq_PAB_q1_personalRisk_scaled[which((rdmGainQualtrics$rdmTrial==1)&(rdmGainQualtrics$phase==1))]; # perceived covid risk, phase 1
covriskphs2 = rdmGainQualtrics$covq_PAB_q1_personalRisk_scaled[which((rdmGainQualtrics$rdmTrial==1)&(rdmGainQualtrics$phase==2))]; # perceived COVID risk, phase 2

var(covriskphs1,na.rm=T); # 0.06312781
var(covriskphs2,na.rm=T); # 0.06240118

mean(covriskphs1,na.rm=T); # 0.5322816
mean(covriskphs2,na.rm=T); # 0.5015385

rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA = (rdmGainQualtrics$covq_PAB_q1_personalRisk-5)/4;
rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA[is.na(rdmGainQualtrics$covq_PAB_q1_personalRisk_centeredscaledNoNA)] = 0;

if(!exists('model_pred_covidRiskCentered_x_dayOverallSC')){
  model_pred_covidRiskCentered_x_dayOverallSC = glmer(rdmChoice ~  1 + covq_PAB_q1_personalRisk_centeredscaledNoNA*dayOverallSC + (1|subID), data=rdmGainQualtrics, family="binomial", na.action=na.exclude, control=glmerControl(optimizer = "bobyqa",optCtrl = list(maxfun=1000000)), offset=predmTask );
}

#                                                          Estimate Std. Error z value Pr(>|z|)   
# (Intercept)                                               0.05343    0.01807   2.956  0.00312 **
# covq_PAB_q1_personalRisk_centeredscaledNoNA               0.01071    0.03546   0.302  0.76265   
# dayOverallSC                                             -0.10857    0.03402  -3.192  0.00141 **
# covq_PAB_q1_personalRisk_centeredscaledNoNA:dayOverallSC -0.22195    0.06870  -3.231  0.00124 **
#
# AIC: 68686.4 <-- worse


# 2) relate changes in risk taking to changes in perceived risk (using a variable that captures the difference in covid risk across phase 1)

# Affective measures... 
# - No observed effects (at this level) for STAIS, STAIT, UCLA-L or PSS
# - covid risk measure predicts less risk -taking
# model w/ covid risk (AIC = 73465.6) outperforms model with phase and day(AIC = 73516.2) and just phase (AIC =73516.4)

```


#### ANALYSIS USING SUBJECT-LEVEL DATA
Affective measures: 
# How do we find what is unique across our qualtrics responses?
# Could do a component type of analysis for all of the qualtrics responses (Gillan et al 2016 does something like this). We could do this in a variety of ways (across all responses v. across all SES responses). Gillan (2016) used a package in R to do it 
# "Try not to get paralyzed by the world of ways to do this stuff - start simple"
# then we move toward correllogram / run factor analysis / PCA stuff

```{r}
# There are two subject-level dataframes
# 1) wide: each participant has a row with separate columns for phase 1 and phase 2 data
# 2) long: each participant has 1-2 rows with one column for variables


# Look at relationship between affective measures (STAIT, STAIS, PSS, UCLAL <--> perceived COVID risk) (overall correlogram)

library("GGally"); # load package we need for correlogram

# phase one only - all affective measures
tmpPhs1 = subLevelWide[names(subLevelWide) %in% c("phs1_stai_s_score_scaled", "phs1_stai_t_score_scaled", "phs1_pss_score_scaled", "phs1_pss_stressedToday", "phs1_uclal_score_scaled", "phs1_covq_PAB_q1_personalRisk_scaled")];
ggpairs(tmpPhs1, title = "Phase 1 correlogram", columnLabels = c("state anxiety", "trait anxiety", "stress", "stress today", "loneliness", "covid risk"));

# phase two only - all affective measures
tmpPhs2 = subLevelWide[names(subLevelWide) %in% c("phs2_stai_s_score_scaled", "phs2_stai_t_score_scaled", "phs2_pss_score_scaled", "phs2_pss_stressedToday", "phs2_uclal_score_scaled", "phs2_covq_PAB_q1_personalRisk_scaled")];
ggpairs(tmpPhs2, title = "Phase 2 correlogram", columnLabels = c("state anxiety", "trait anxiety", "stress", "stress today", "loneliness", "covid risk"));

# phase 1 and 2 covid risk
tmpCovidRisk = subLevelWide[names(subLevelWide) %in% c("phs1_covq_PAB_q1_personalRisk_scaled", "phs2_covq_PAB_q1_personalRisk_scaled")];
ggpairs(tmpCovidRisk, title = "covid risky between phases", columnLabels = c("phs 1 covid risk", "phs 2 covid risk"));


# difference in covid risk across phases (just plot it)
subLevelWide$covidRiskDiff = subLevelWide$phs1_covq_PAB_q1_personalRisk_scaled - subLevelWide$phs2_covq_PAB_q1_personalRisk_scaled;
hist(subLevelWide$covidRiskDiff, main=sprintf("covid risk difference\n mean = %.5s, range = %s - %s", mean(subLevelWide$covidRiskDiff, na.rm=T), min(subLevelWide$covidRiskDiff, na.rm = T), c(max(subLevelWide$covidRiskDiff,na.rm=T)) ), xlab = "phase 1 - phase 2", ylab="number of people", breaks=10);
# 98 people have covidriskDiff = 0 (histogram shows the 98 below zero)

# how does change in covid risk relate to phase 2 (end-state affect)
tmpPhs2covidDiff = subLevelWide[names(subLevelWide) %in% c("phs2_stai_s_score_scaled", "phs2_stai_t_score_scaled", "phs2_pss_score_scaled", "phs2_pss_stressedToday", "phs2_uclal_score_scaled", "covidRiskDiff")];
ggpairs(tmpPhs2covidDiff, title = "Phase 2 correlogram with covid risk diff", columnLabels = c("state anxiety", "trait anxiety", "stress", "stress today", "loneliness", "covid risk diff"));
# not seeing a relationship between change covid risk and end state affect (phase 2)


# difference in stait across phases (just plot it)
staitDiff = subLevelWide$phs1_stai_t_score_scaled - subLevelWide$phs2_stai_t_score_scaled
hist(staitDiff, main=sprintf("stait difference\n mean = %.5s, range = %s - %s", mean(staitDiff, na.rm=T), min(staitDiff, na.rm = T), c(max(staitDiff,na.rm=T)) ), xlab = "phase 1 - phase 2", ylab="number of people", breaks=10);

# difference in stais across phases (just plot it)
staisDiff = subLevelWide$phs1_stai_s_score_scaled - subLevelWide$phs2_stai_s_score_scaled
hist(staisDiff, main=sprintf("stais difference\n mean = %.5s, range = %s - %s", mean(staisDiff, na.rm=T), min(staisDiff, na.rm = T), c(max(staisDiff,na.rm=T)) ), xlab = "phase 1 - phase 2", ylab="number of people", breaks=10);

# difference in pss across phases (just plot it)
pssDiff = subLevelWide$phs1_pss_score_scaled - subLevelWide$phs2_pss_score_scaled
hist(pssDiff, main=sprintf("pss difference\n mean = %.5s, range = %s - %s", mean(pssDiff, na.rm=T), min(pssDiff, na.rm = T), c(max(pssDiff,na.rm=T)) ), xlab = "phase 1 - phase 2", ylab="number of people", breaks=10);

# difference in uclal across phases (just plot it)
uclalDiff = subLevelWide$phs1_uclal_score_scaled - subLevelWide$phs2_uclal_score_scaled
hist(uclalDiff, main=sprintf("uclal difference\n mean = %.5s, range = %s - %s", mean(uclalDiff, na.rm=T), min(uclalDiff, na.rm = T), c(max(uclalDiff,na.rm=T)) ), xlab = "phase 1 - phase 2", ylab="number of people", breaks=10);



# SES questions (there are 11 of them in both phases)
# how does change in covid risk relate to phase 2 (end-state affect)
sesDFphs1= subLevelWide[names(subLevelWide) %in% c("phs1_ses_childhood_freeReducedLunch_recode",
                                               "phs1_ses_childhood_communityComp_recode",
                                               "phs1_ses_childhood_nationalComp_recode",
                                               "phs1_ses_motherEdLevel_recode",
                                               "phs1_ses_fatherEdLevel_recode" ,
                                               "phs1_ses_childhoood_homeOwnership_recode" ,
                                               "phs1_ses_personalEdLevel_recode",
                                               "phs1_ses_financialWorryFreq_recode",
                                               "phs1_ses_needbasedCollegeAid_recode")];

ggpairs(sesDFphs1, title = "Phase 1 correlogram with SES", columnLabels = c("reduced lunch", "communityComp", "nationalComp", "momED", "dadED", "childHomeOwn", "personalEDlev", "worryFreq", "collegeAid"));


sesDFphs2= subLevelWide[names(subLevelWide) %in% c("phs2_ses_childhood_freeReducedLunch_recode",
                                               "phs2_ses_childhood_communityComp_recode",
                                               "phs2_ses_childhood_nationalComp_recode",
                                               "phs2_ses_motherEdLevel_recode",
                                               "phs2_ses_fatherEdLevel_recode" ,
                                               "phs2_ses_childhoood_homeOwnership_recode" ,
                                               "phs2_ses_personalEdLevel_recode",
                                               "phs2_ses_financialWorryFreq_recode",
                                               "phs2_ses_needbasedCollegeAid_recode")];

ggpairs(sesDFphs2, title = "Phase 2 correlogram with SES", columnLabels = c("reduced lunch", "communityComp", "nationalComp", "momED", "dadED", "childHomeOwn", "personalEDlev", "worryFreq", "collegeAid"));


# Removed 1) current bill help because it was very unrelated to the others which could be the result of differences in the way participants interpreted the question and 2) current responsibilities because it categorical or ordered
# Phase 1 and phase 2 broadly similar

#looking at differences in responses across phases:
# need to plot this so we can see how many points were different:
for (c in 1:ncol(sesDFphs1)) {
  plot(sesDFphs1[,c],sesDFphs2[,c])
}


# Next: moving toward "sophisticated", data-driven way would be to move toward PCA with a "smartly-weighted" combination of the components.
# look at variance and do variance test of covid risk
# is covid risk related to any of the affective measures? - answered above
# is change in covid risk related to change in affective measures - not done yet



# - COVID Q analysis (multiple COVID questions - internally correlated?) [is perceived COVID risk similar or different from other COVID measures]
#   - use PCA or similar data-driven approach? (within phase 1)
#   - trends across days/phases
# - Affective measures analysis
#   - use PCA or similar data-driven approach? (within phase 1)
#   - trends across days/phases



```

```{r}
# PCA for SES (using 9 out of 11 SES measures - see above for why we removed two)

sesPhs1pca = prcomp(na.omit(sesDFphs1), center=TRUE, scale = TRUE);
# Importance of components:
#                           PC1    PC2    PC3     PC4     PC5     PC6     PC7     PC8     PC9
# Standard deviation     1.7691 1.0553 0.9940 0.91984 0.90520 0.81163 0.76623 0.70331 0.60209
# Proportion of Variance 0.3478 0.1237 0.1098 0.09401 0.09104 0.07319 0.06523 0.05496 0.04028
# Cumulative Proportion  0.347s8 0.4715 0.5813 0.67529 0.76633 0.83953 0.90476 0.95972 1.00000

# accessing component for each person looks like:
sesPhs1pca$x[,'PC1'] # where each row is a person
# we want to add this for each participant in both RDM and control datasets
# MOVE THIS ANALYSIS TO ITS OWN SCRIPT AND THEN ADD TO RDMGAINQUALTRICS/RDMLOSSQUALTRICS ALONG WITH THE AX DATASET.



sesPhs2pca = prcomp(na.omit(sesDFphs2), center=TRUE, scale = TRUE);

# Importance of components:
#                          PC1    PC2    PC3     PC4     PC5     PC6     PC7     PC8     PC9
# Standard deviation     1.7939 1.0824 1.0059 0.90077 0.85045 0.81266 0.74929 0.68261 0.61331
# Proportion of Variance 0.3576 0.1302 0.1124 0.09015 0.08036 0.07338 0.06238 0.05177 0.04179
# Cumulative Proportion  0.3576 0.4877 0.6001 0.69031 0.77067 0.84405 0.90643 0.95821 1.00000

# the components in both phases are very similar
# for example, comparing PC1 in phase 1 and 2:
plot(as.vector(sesPhs1pca$rotation[,1]),as.vector(sesPhs2pca$rotation[,1]));


```


Look at corellograms and do PCA with covid questions
```{r}
# COVID-19 QUESTIONS questions (there are 9 of them in both phases)
# phase 1:
covqDFphs1= subLevelWide[names(subLevelWide) %in% c("phs1_covq_PAB_q1_personalRisk_scaled",
                                               "phs1_covq_PAB_q2_threat",
                                               "phs1_covq_PAB_q3_personallyDie",
                                               "phs1_covq_PAB_q4_otherPersonDie",
                                               "phs1_covq_PAB_q5_currentCases_recode" ,
                                               "phs1_covq_PAB_q6_tested_recode" ,
                                               "phs1_covq_PAB_q7_personalCovidSuspect_recode",
                                               "phs1_covq_PAB_q8_knowPositivePerson_recode",
                                               "phs1_covq_PAB_q9_socialDistanceLevel_recode")];

ggpairs(covqDFphs1, title = "Phase 1 correlogram COVID Qs", columnLabels = c("personal risk", "threat", "personal death", "death of other", "current cases", "tested", "suspected covid", "know positive person", "social distance"));


# phase 2:
covqDFphs2= subLevelWide[names(subLevelWide) %in% c("phs2_covq_PAB_q1_personalRisk_scaled",
                                               "phs2_covq_PAB_q2_threat",
                                               "phs2_covq_PAB_q3_personallyDie",
                                               "phs2_covq_PAB_q4_otherPersonDie",
                                               "phs2_covq_PAB_q5_currentCases_recode" ,
                                               "phs2_covq_PAB_q6_tested_recode" ,
                                               "phs2_covq_PAB_q7_personalCovidSuspect_recode",
                                               "phs2_covq_PAB_q8_knowPositivePerson_recode",
                                               "phs2_covq_PAB_q9_socialDistanceLevel_recode")];

ggpairs(covqDFphs2, title = "Phase 2 correlogram COVID Qs", columnLabels = c("personal risk", "threat", "personal death", "death of other", "current cases", "tested", "suspected covid", "know positive person", "social distance"));


covqDiff = covqDFphs2-covqDFphs1; # take the difference in covid qs between phase 2 and phase 1

covqDifftopFive = covqDiff[names(covqDiff) %in% c("phs2_covq_PAB_q1_personalRisk_scaled",
                                               "phs2_covq_PAB_q2_threat",
                                               "phs2_covq_PAB_q3_personallyDie",
                                               "phs2_covq_PAB_q4_otherPersonDie",
                                           "phs2_covq_PAB_q8_knowPositivePerson_recode")];

colnames(covqDifftopFive) = c("personalRiskDiff", "threatDiff", "personallyDieDiff", "otherPersonDieDiff", "knowPosPersonDiff");

ggpairs(covqDifftopFive, title = "Diff correlogram COVID Qs", columnLabels = c("personal risk", "threat", "personal death", "death of other","know positive person"));



# The top five covid qs that stand out are personal risk, threat, personal death, death of other and know any one who tested positive. However, the know anyone who tested positive is coded funky and its unclear whats happening there. The change across phases for the top four (throwing out know anyone who tested positive right now) is pretty small, but the changes in personal risk distribution are related to RDM and the distribution of changes across phases is widest (ie it has the biggest change) and may be the variable to go with. The top four variables are highly related and the degree to which they change across phases is also correlated. 


mean(covqDifftopFive$personalRiskDiff, na.rm=T); #-0.03416399*6 = -0.2049839 (to match the scale with the following cov qs becase personal risk is on a 0-1 scale)
mean(covqDifftopFive$threatDiff, na.rm=T); # -0.09385113
mean(covqDifftopFive$personallyDieDiff, na.rm=T); # -0.01612903
mean(covqDifftopFive$otherPersonDieDiff, na.rm=T); # -0.1864952
mean(covqDifftopFive$knowPosPersonDiff, na.rm=T); # 0.0192926
# largest difference is with personal risk, followed by other personally die

var(covqDifftopFive$personalRiskDiff*6, na.rm=T); #1.726999 (multiplied score by 6 because math for variance is more complicated)
var(covqDifftopFive$threatDiff, na.rm=T); # 1.247657
var(covqDifftopFive$personallyDieDiff, na.rm=T); # 1.129189
var(covqDifftopFive$otherPersonDieDiff, na.rm=T); # 1.752204
var(covqDifftopFive$knowPosPersonDiff, na.rm=T); # 0.7609169

# highest variance is other person die followed by personal risk (very similar)
# moving toward rationalizing why we should use to personal risk (While also accounting for other die?)
# Change in personal risk and death of other are not as correlated as we'd think given their relationship within each phase. This could be that the change is just noise and so there is no meaningful shift that is happening. 

# next: looking at these measures relative to affect and cognition.

```

```{r}
# PCA for COVID Q (using 4 out of 9 covid q measures - see above for why we are going with these)
# personal risk, threat, personal death, death of other

covqDFphs1top4 = covqDFphs1[names(covqDFphs1) %in% c("phs1_covq_PAB_q1_personalRisk_scaled",
                                               "phs1_covq_PAB_q2_threat",
                                               "phs1_covq_PAB_q3_personallyDie",
                                               "phs1_covq_PAB_q4_otherPersonDie")];

covqDFphs2top4 = covqDFphs2[names(covqDFphs2) %in% c("phs2_covq_PAB_q1_personalRisk_scaled",
                                               "phs2_covq_PAB_q2_threat",
                                               "phs2_covq_PAB_q3_personallyDie",
                                               "phs2_covq_PAB_q4_otherPersonDie")];

covqPhs1pca = prcomp(na.omit(covqDFphs1top4), center=TRUE, scale = TRUE);

#                                            PC1         PC2        PC3        PC4
# phs1_covq_PAB_q1_personalRisk_scaled 0.5401573 -0.02755631 -0.4234984  0.7267185
# phs1_covq_PAB_q2_threat              0.4790945 -0.74859950 -0.1055662 -0.4460079
# phs1_covq_PAB_q3_personallyDie       0.4916882  0.65374743 -0.2787753 -0.5031316
# phs1_covq_PAB_q4_otherPersonDie      0.4867661  0.10702212  0.8554468  0.1407687

# Importance of components:
#                           PC1    PC2    PC3     PC4
# Standard deviation     1.5507 0.8102 0.7534 0.60931
# Proportion of Variance 0.6012 0.1641 0.1419 0.09281
# Cumulative Proportion  0.6012 0.7653 0.9072 1.00000



covqPhs2pca = prcomp(na.omit(covqDFphs2top4), center=TRUE, scale = TRUE);

#                                             PC1        PC2         PC3        PC4
# phs2_covq_PAB_q1_personalRisk_scaled -0.5410720  0.0179990  0.45667265 -0.7059513
# phs2_covq_PAB_q2_threat              -0.4522386  0.8046309  0.02591976  0.3838977
# phs2_covq_PAB_q3_personallyDie       -0.4996101 -0.5650718  0.31816180  0.5743316
# phs2_covq_PAB_q4_otherPersonDie      -0.5031014 -0.1814910 -0.83039227 -0.1562006

# Importance of components:
#                           PC1    PC2    PC3     PC4
# Standard deviation     1.5514 0.8357 0.7212 0.61199
# Proportion of Variance 0.6017 0.1746 0.1300 0.09363
# Cumulative Proportion  0.6017 0.7763 0.9064 1.00000

# similar pattern in phase 2


# Component one weighs each of the four components roughly equally and accounts for 60% of the variance. This could mean that picking one variable (i.e. personal risk) would be ok and the argument for would be that its more straightforward and more interpretable. The counter argument would be to use the weighted average of the four variables.

# Going ahead using personal risk variable for now.


```


```{r}

# TEMPORAL CONTEXT WITH COVID RISK:
if(!exists('model_pred_3timescales_covidRisk')){
  model_pred_3timescales_covidRisk = glm(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + covq_PAB_q1_personalRisk_scaledNoNA + (1|subID), data=rdmGainQualtrics, family="binomial", offset=predmTask);
}

# AIC = 67085.1
# only covid risk not significant
# trial and earning opposite effects (both v sig)
# poc effect significant and has a negative interaction with earnings
# singular
# nObs = 97093

# TEMPORAL CONTEXT WITHOUT COVID RISK:
if(!exists('model_pred_3timescales')){
  model_pred_3timescales= glmer(rdmChoice ~ 0 + rdmPOC1sc*rdmEarningSC + posShift +  rdmTrialSC + (1|subID), data=rdmGainQualtrics, family="binomial", offset=predmTask);
}

# AIC =  67083.9
# everything significant, positive effect of past outcome, earnings (positive) and trial (negative) have opposing effects, shift positive, interaction between past outcome and earnings negative
# singular
# nObs = 97093
```



```{r}
# save our models
save(file=outputfile, list=ls(pattern=glob2rx("model*"))); 
```

